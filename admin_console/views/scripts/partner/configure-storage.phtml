<form
	action="<?php echo $this->url ( array ('controller' => 'partner', 'action' => 'configure-storage' )); ?>"
	method="post" enctype="application/x-www-form-urlencoded"
	id="frmStorageConfig" class="<?php echo ($this->formValid) ? 'valid' : 'invalid'; ?>">

<?php echo $this->form; ?>
			
<script type="text/javascript">
jQuery('[class=commentForm]').toggle();

jQuery(document).ready(function() {
	// Get selected storage protocol
	var protocolUpdateView = function( protocol ) {
		
		switch ( protocol )
		{
		case "<?php echo Kaltura_Client_Enum_StorageProfileProtocol::S3?>":				
			jQuery('#filesPermissionInS3-label').css('visibility', 'visible');
			jQuery('#filesPermissionInS3').css('visibility', 'visible');
			jQuery('#storageFtpPassiveMode').css('visibility', 'hidden');
			jQuery('#storageFtpPassiveMode-label').css('visibility', 'hidden');
			break;
		case "<?php echo Kaltura_Client_Enum_StorageProfileProtocol::FTP?>":
			jQuery('#storageFtpPassiveMode').css('visibility', 'visible');
			jQuery('#storageFtpPassiveMode-label').css('visibility', 'visible');
			jQuery('#filesPermissionInS3-label').css('visibility', 'hidden');
			jQuery('#filesPermissionInS3').css('visibility', 'hidden');			
			break;
		default:
			jQuery('#filesPermissionInS3').css('visibility', 'hidden');
			jQuery('#filesPermissionInS3-label').css('visibility', 'hidden');
			jQuery('#storageFtpPassiveMode').css('visibility', 'hidden');
			jQuery('#storageFtpPassiveMode-label').css('visibility', 'hidden');
			break;
		}
	};

	protocolUpdateView(<?php echo "'".$this->protocol."'"?>);

	<?php if ($this->formValid): ?>
		dialogDiv.dialog('close');
		jQuery('#frmPartnerFilter').submit();
	<?php endif; ?>

	updatedUI();
});

function addDeliveryProfileFormats() {

	currentFormats = getPlaybackProtocols();
	jQuery('#deliveryFormat').empty();
	
	var dpIdsStr = jQuery('#deliveryProfileIds').val();
	var dpIdsJson = jQuery.parseJSON(dpIdsStr);

	for(format in dpIdsJson) {
		if(currentFormats[format])
			delete currentFormats[format];
	}

	for(format in currentFormats) {
		jQuery('#deliveryFormat').append(new Option(currentFormats[format], format));
	}
}

function getPlaybackProtocols() {
	var playbackDict = {};
	playbackDict["http"] = "HTTP";
	playbackDict["rtmp"] = "RTMP";
	playbackDict["sl"] = "SILVER_LIGHT";
	playbackDict["applehttp"] = "APPLE_HTTP";
	playbackDict["rtsp"] = "RTSP";
	playbackDict["hds"] = "HDS";
	playbackDict["hls"] = "HLS";
	playbackDict["hdnetworkmanifest"] = "AKAMAI_HDS";
	playbackDict["hdnetwork"] = "AKAMAI_HD";
	return playbackDict;
}

function createDeliveryProfilesTable() 
{
	if(jQuery('#deliveryProfilesTable'))
		jQuery('#deliveryProfilesTable').remove();
	
	var dpIdsStr = jQuery('#deliveryProfileIds').val();
	var dpIdsJson = jQuery.parseJSON(dpIdsStr);
	var tbl = document.createElement('table');

	createTitles(tbl);
	for(format in dpIdsJson)
		addFormatRow(tbl, format, dpIdsJson[format]);

	jQuery('#deliveryProfileIds').after(tbl);
	$(tbl).attr('id', 'deliveryProfilesTable');
}

function createTitles(tbl) {
	var row = document.createElement('tr');	
	var tdFormat = document.createElement('td');
	tdFormat.innerHTML = "<b>Format</b>";
	var tdIds = document.createElement('td');
	tdIds.innerHTML = "<b>Delivery profiles</b>";
	var tdEdit = document.createElement('td');
	var tdRemove = document.createElement('td');
	$(row).append(tdFormat).append(tdIds).append(tdEdit).append(tdRemove);
	$(tbl).append(row);
}

function addFormatRow(tbl, format, deliveryProfileIds) 
{
	var row = document.createElement('tr');	
	var tdFormat = document.createElement('td');
	tdFormat.innerHTML = format;
	var tdDPIds = document.createElement('td');
	tdDPIds.innerHTML = deliveryProfileIds;
	var tdEdit = document.createElement('td');
	tdEdit.innerHTML = '<button onclick="editDeliveryProfile(\'' +format+'\',[' + deliveryProfileIds+ ']);">Edit</button>';
	var tdRemove = document.createElement('td');
	tdRemove.innerHTML = '<button onclick="removeFormat(\'' +format+'\');">Remove</button>';

	$(row).append(tdFormat).append(tdDPIds).append(tdEdit).append(tdRemove);
	$(tbl).append(row);
}

function addDeliveryProfile() {
	var deliveryFormat = jQuery('#deliveryFormat').val();
	editDeliveryProfile(deliveryFormat, null);
}

function editDeliveryProfile(format, currentDps)
{
	var storageProfileId = $("#storageId")[0].value;

	var url = '<?php echo $this->url(array('controller' => 'partner', 'action' => 'edit-delivery-profile')); ?>';
	url += '/currentDeliveryProfiles/' + currentDps + "/";
	var dialogDiv = jQuery('<div id="confirmation-div"></div>').appendTo('body');
	
	dialogDiv.dialog({
		bgiframe: true,
		modal: true,
		resizable: false,
		width: 750,
		title: '<?php echo $this->translate('Edit delivery profiles : Storage id '); ?>' + storageProfileId +
			'<?php echo $this->translate(' , Format '); ?>' + format,
		height: 400,
		buttons: {			
			'<?php echo $this->translate('OK'); ?>': function() {
				okPressed(format);
				jQuery(this).dialog('close').remove();
			},
		},
		close: function() {
			$(this).dialog('close').remove();
		}
	});
	dialogDiv.load(
			url
		);
}

function removeFormat(format) {
	var dpIdsStr = $("#deliveryProfileIds")[0].value;
	var dpIdsObj = jQuery.parseJSON(dpIdsStr);

	delete dpIdsObj[format];

	$("#deliveryProfileIds")[0].value = JSON.stringify(dpIdsObj);
	updatedUI();
}

function okPressed(format) {

	var selectedValues = [];
	$("#selectedValues option").each(function() {selectedValues.push(parseInt(this.value));});
	
	var dpIdsStr = $("#deliveryProfileIds")[0].value;
	var dpIdsObj = jQuery.parseJSON(dpIdsStr);

	dpIdsObj[format] = selectedValues;
	$("#deliveryProfileIds")[0].value = JSON.stringify(dpIdsObj);

	updatedUI();
}

function updatedUI() {
	createDeliveryProfilesTable();
	addDeliveryProfileFormats();
}

</script>
</form>


